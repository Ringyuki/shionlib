import { expect, test } from '@playwright/test'
import {
  E2E_FIXTURES,
  applyAuthCookiesToPageContext,
  loginAndExtractAuthCookies,
} from '../_helpers/fixtures.mjs'

const expectApiSuccess = async response => {
  if (!response.ok()) {
    const body = await response.text().catch(() => '<unreadable>')
    throw new Error(`Request failed: ${response.status()} ${response.url()} body=${body}`)
  }
  const payload = await response.json()
  expect(payload?.code).toBe(0)
  return payload?.data
}

const getAdminMalwareCaseDetail = async (request, adminAuth, caseId) => {
  return await expectApiSuccess(
    await request.get(`/api/admin/content/malware-scan-cases/${caseId}`, {
      headers: {
        cookie: adminAuth.cookieHeader,
      },
    }),
  )
}

const waitForAdminMalwareCaseStatus = async (
  request,
  adminAuth,
  caseId,
  expectedStatus,
  timeoutMs = 10_000,
) => {
  const startedAt = Date.now()

  while (Date.now() - startedAt < timeoutMs) {
    const detail = await getAdminMalwareCaseDetail(request, adminAuth, caseId)
    if (detail?.status === expectedStatus) {
      return detail
    }
    await new Promise(resolve => setTimeout(resolve, 300))
  }

  throw new Error(`Timed out waiting malware case status=${expectedStatus}, id=${caseId}`)
}

const findPendingMalwareCase = async (request, adminAuth) => {
  const data = await expectApiSuccess(
    await request.get('/api/admin/content/malware-scan-cases?page=1&pageSize=20&status=PENDING', {
      headers: {
        cookie: adminAuth.cookieHeader,
      },
    }),
  )
  const firstPending = Array.isArray(data?.items) ? data.items[0] : null
  return firstPending ?? null
}

const filterCasesByFileId = async (page, fileId) => {
  const fileIdInput = page.getByPlaceholder('File ID')
  await expect(fileIdInput).toBeVisible()

  const responsePromise = page.waitForResponse(response => {
    const url = response.url()
    return url.includes('/admin/content/malware-scan-cases') && url.includes(`file_id=${fileId}`)
  })

  await fileIdInput.fill(String(fileId))
  await fileIdInput.blur()
  await responsePromise
}

const findCaseRow = async (page, caseId, timeoutMs = 15_000) => {
  const row = page
    .locator('div.rounded-lg.border.p-4')
    .filter({
      hasText: `Case ID: ${caseId}`,
    })
    .first()
  await expect(row).toBeVisible({ timeout: timeoutMs })
  return row
}

test.describe('Admin malware scans UI', () => {
  test('malware scans page should support list/detail and review submission', async ({
    page,
    request,
  }) => {
    const adminAuth = await loginAndExtractAuthCookies(
      request,
      E2E_FIXTURES.users.admin.identifier,
      E2E_FIXTURES.users.admin.password,
    )
    await applyAuthCookiesToPageContext(page, adminAuth)

    const pendingCase = await findPendingMalwareCase(request, adminAuth)
    test.skip(!pendingCase, 'No pending malware scan case found in dataset.')

    const response = await page.goto('/en/admin/malware-scans')
    expect(response).not.toBeNull()
    expect(response.ok()).toBeTruthy()

    await filterCasesByFileId(page, pendingCase.file.id)
    const row = await findCaseRow(page, pendingCase.id)
    await row.getByRole('button', { name: 'View Details' }).click()
    await expect(page.getByRole('heading', { name: 'Malware Case Details' })).toBeVisible()

    const detailDialog = page.getByRole('dialog').first()
    const virusText = pendingCase.detected_viruses?.[0] || 'No detected virus names'
    await expect(detailDialog.getByText(virusText, { exact: true })).toBeVisible()

    const reviewNote = `e2e malware review note ${Date.now()}`
    await detailDialog.getByPlaceholder('Add review note (optional)').fill(reviewNote)

    const decisionSelectTrigger = detailDialog.locator('button[role="combobox"]').first()
    await decisionSelectTrigger.click()
    await page.getByRole('option', { name: 'Delete file and resource' }).click()

    const notifyCheckbox = detailDialog.getByRole('checkbox')
    await expect(notifyCheckbox).toHaveAttribute('aria-checked', 'true')
    await notifyCheckbox.click()
    await expect(notifyCheckbox).toHaveAttribute('aria-checked', 'false')

    const reviewResponse = page.waitForResponse(response => {
      return (
        response.request().method() === 'PATCH' &&
        response.url().includes(`/admin/content/malware-scan-cases/${pendingCase.id}/review`)
      )
    })

    await detailDialog.getByRole('button', { name: 'Submit Review' }).click()
    await expectApiSuccess(await reviewResponse)
    await expect(page.getByRole('heading', { name: 'Malware Case Details' })).toBeHidden()

    const reviewedCase = await waitForAdminMalwareCaseStatus(
      request,
      adminAuth,
      pendingCase.id,
      'DELETED',
    )
    expect(reviewedCase?.decision_source).toBe('ADMIN_DELETE')
    expect(reviewedCase?.review_note).toBe(reviewNote)
    expect(reviewedCase?.reviewed_at).toBeTruthy()
    expect(reviewedCase?.reviewer?.id).toBeDefined()
  })
})
