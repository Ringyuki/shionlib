// @vitest-environment jsdom
import { renderHook, waitFor } from '@testing-library/react'
import { beforeEach, describe, expect, it, vi } from 'vitest'

const hoisted = vi.hoisted(() => {
  const get = vi.fn()
  const post = vi.fn()
  const patch = vi.fn()
  const put = vi.fn()
  const del = vi.fn()

  return {
    get,
    post,
    patch,
    put,
    del,
    requestFactory: vi.fn(() => ({
      get,
      post,
      patch,
      put,
      delete: del,
    })),
  }
})

vi.mock('@/utils/request', () => ({
  shionlibRequest: hoisted.requestFactory,
}))

import {
  getAdminMalwareScanCaseDetail,
  reviewAdminMalwareScanCase,
  useAdminMalwareScanCaseList,
} from '../../../../components/admin/hooks/useAdminMalwareScans'

describe('components/admin/hooks/useAdminMalwareScans (unit)', () => {
  beforeEach(() => {
    hoisted.get.mockReset()
    hoisted.post.mockReset()
    hoisted.patch.mockReset()
    hoisted.put.mockReset()
    hoisted.del.mockReset()
    hoisted.requestFactory.mockClear()
  })

  it('fetches malware scan list with full filters', async () => {
    const payload = { items: [], page: 1, pageSize: 20, total: 0 }
    hoisted.get.mockResolvedValue({ data: payload })

    const { result } = renderHook(() =>
      useAdminMalwareScanCaseList({
        page: 1,
        limit: 20,
        status: 'PENDING',
        decision_source: 'MODEL',
        file_id: 10,
        resource_id: 11,
        uploader_id: 12,
        reviewer_id: 13,
        sortBy: 'created',
        sortOrder: 'DESC',
      } as any),
    )

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false)
    })

    expect(hoisted.get).toHaveBeenCalledWith(
      '/admin/content/malware-scan-cases?page=1&pageSize=20&status=PENDING&decision_source=MODEL&file_id=10&resource_id=11&uploader_id=12&reviewer_id=13&sortBy=created&sortOrder=DESC',
    )
    expect(result.current.data).toEqual(payload)
  })

  it('calls detail and review endpoints', async () => {
    hoisted.get.mockResolvedValue({ data: { id: 8 } })
    hoisted.patch.mockResolvedValue({ data: { id: 8, decision: 'ALLOW' } })

    await expect(getAdminMalwareScanCaseDetail(8)).resolves.toEqual({ id: 8 })
    await expect(
      reviewAdminMalwareScanCase(8, { decision: 'ALLOW' as any, review_note: 'ok' }),
    ).resolves.toEqual({ id: 8, decision: 'ALLOW' })

    expect(hoisted.get).toHaveBeenCalledWith('/admin/content/malware-scan-cases/8')
    expect(hoisted.patch).toHaveBeenCalledWith('/admin/content/malware-scan-cases/8/review', {
      data: { decision: 'ALLOW', review_note: 'ok' },
    })
  })
})
